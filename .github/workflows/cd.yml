name: CD

on:
  push:
    branches: [ main ]
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'push' }}
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

    - name: Deploy to Cloudpanel VPS
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          set -e

          echo "ğŸš€ Starting fully automated deployment of Wick Wax Relax"

          # Check if PostgreSQL is installed, install if not
          echo "ğŸ” Checking PostgreSQL installation..."
          if ! command -v psql &> /dev/null; then
            echo "ğŸ“¦ Installing PostgreSQL..."
            sudo apt update
            sudo apt install -y postgresql postgresql-contrib

            # Start and enable PostgreSQL
            sudo systemctl start postgresql
            sudo systemctl enable postgresql

            echo "âœ… PostgreSQL installed and started"
          else
            echo "âœ… PostgreSQL already installed"
          fi

          # Create database and user if they don't exist
          echo "ğŸ—„ï¸ Setting up PostgreSQL database and user..."
          sudo -u postgres psql -c "SELECT 1 FROM pg_roles WHERE rolname = 'wick_wax_user';" | grep -q 1 || \
            sudo -u postgres psql -c "CREATE USER wick_wax_user WITH PASSWORD '${{ secrets.DB_PASSWORD }}' LOGIN;"

          sudo -u postgres psql -c "SELECT 1 FROM pg_database WHERE datname = 'wick_wax_relax';" | grep -q 1 || \
            sudo -u postgres psql -c "CREATE DATABASE wick_wax_relax OWNER wick_wax_user;"

          sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE wick_wax_relax TO wick_wax_user;"

          # Configure PostgreSQL authentication for the new user
          echo "ğŸ”§ Configuring PostgreSQL authentication..."
          sudo -u postgres psql -d wick_wax_relax -c "GRANT ALL ON SCHEMA public TO wick_wax_user;"
          sudo -u postgres psql -d wick_wax_relax -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO wick_wax_user;"
          sudo -u postgres psql -d wick_wax_relax -c "GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO wick_wax_user;"

          # Set default privileges for future tables
          sudo -u postgres psql -d wick_wax_relax -c "ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO wick_wax_user;"
          sudo -u postgres psql -d wick_wax_relax -c "ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO wick_wax_user;"

          # Test database connection with the new user
          echo "ğŸ§ª Testing database connection..."
          if PGPASSWORD="${{ secrets.DB_PASSWORD }}" psql -h localhost -U "wick_wax_user" -d "wick_wax_relax" -c "SELECT 1;" >/dev/null 2>&1; then
            echo "âœ… PostgreSQL database and user configured successfully"
          else
            echo "âŒ Failed to connect to PostgreSQL with the new user"
            echo "ğŸ” Debugging connection issue..."
            echo "Checking if PostgreSQL is running..."
            sudo systemctl status postgresql || echo "PostgreSQL is not running"
            echo "Checking user exists..."
            sudo -u postgres psql -c "\du" | grep wick_wax_user || echo "User does not exist"
            echo "Checking database exists..."
            sudo -u postgres psql -c "\l" | grep wick_wax_relax || echo "Database does not exist"
            exit 1
          fi

          # Navigate to project directory
          cd /home/wickwaxrelax/htdocs/www.wickwaxrelax.co.uk

          # Pull latest changes
          echo "ğŸ“¥ Pulling latest code..."
          git pull origin main

          # Install/update backend dependencies
          echo "ğŸ“¦ Installing backend dependencies..."
          cd backend
          npm install

          # Install/update frontend dependencies
          echo "ğŸ“¦ Installing frontend dependencies..."
          cd ../frontend
          npm install

          # Initialize PostgreSQL database with complete schema
          echo "ğŸ—„ï¸ Initializing PostgreSQL database schema..."
          cd ../backend

          # Create .env file for database initialization
          cat > .env.init << ENVEOF
          NODE_ENV=production
          DB_HOST=localhost
          DB_PORT=5432
          DB_NAME=wick_wax_relax
          DB_USER=wick_wax_user
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          ENVEOF

          # Set PGPASSWORD environment variable for PostgreSQL connection
          export PGPASSWORD="${{ secrets.DB_PASSWORD }}"

          # Test connection once more before initialization
          echo "ğŸ§ª Pre-initialization connection test..."
          if psql -h localhost -U "wick_wax_user" -d "wick_wax_relax" -c "SELECT 1;" >/dev/null 2>&1; then
            echo "âœ… Connection test passed, proceeding with initialization"
            env $(cat .env.init | xargs) npm run db:init
          else
            echo "âŒ Connection test failed, attempting alternative initialization..."
            # Try with postgres user as fallback
            sudo -u postgres psql -d wick_wax_relax -f ../migrations/001_initial_schema.sql
            sudo -u postgres psql -d wick_wax_relax -f ../migrations/002_product_variants.sql
            sudo -u postgres psql -d wick_wax_relax -f ../migrations/003_product_categories.sql
            sudo -u postgres psql -d wick_wax_relax -f ../migrations/004_user_accounts.sql
            sudo -u postgres psql -d wick_wax_relax -f ../migrations/005_order_items.sql
            sudo -u postgres psql -d wick_wax_relax -f ../migrations/006_inventory_audit_log.sql
            sudo -u postgres psql -d wick_wax_relax -f ../migrations/007_product_images.sql
            sudo -u postgres psql -d wick_wax_relax -f ../migrations/007_add_refresh_token.sql
            sudo -u postgres psql -d wick_wax_relax -f ../migrations/008_add_tracking_fields.sql
            sudo -u postgres psql -d wick_wax_relax -f ../migrations/009_security_audit_log.sql
            sudo -u postgres psql -d wick_wax_relax -f ../migrations/009_suppliers.sql
            sudo -u postgres psql -d wick_wax_relax -f ../migrations/010_gdpr_consent_tracking.sql
            sudo -u postgres psql -d wick_wax_relax -f ../migrations/010_platform_settings.sql
            sudo -u postgres psql -d wick_wax_relax -f ../migrations/011_performance_indexes.sql
            sudo -u postgres psql -d wick_wax_relax -f ../migrations/012_hierarchical_categories.sql
            
            # Seed initial data with postgres user
            echo "ğŸŒ± Seeding initial data with postgres user..."
            sudo -u postgres psql -d wick_wax_relax -c "INSERT INTO channels (id, name, api_key) VALUES ('pwa-channel', 'PWA', 'pwa-api-key') ON CONFLICT (name) DO NOTHING;"
            
            # Create admin user with postgres user
            ADMIN_PASSWORD_HASH=$(node -e "const bcrypt = require('bcrypt'); bcrypt.hash('admin123', 10).then(hash => console.log(hash))")
            sudo -u postgres psql -d wick_wax_relax -c "INSERT INTO users (id, email, password_hash, first_name, last_name) VALUES ('admin-user', 'admin@wickwaxrelax.co.uk', '$ADMIN_PASSWORD_HASH', 'Admin', 'User') ON CONFLICT (email) DO NOTHING;"
            
            echo "âœ… Database initialization completed with postgres user fallback"
          fi

          # Clean up temporary env file
          rm -f .env.init

          # Build frontend for production
          echo "ğŸ”¨ Building frontend..."
          cd ../frontend
          # Ensure next binary has execute permissions
          chmod +x ./node_modules/.bin/next
          ./node_modules/.bin/next build

          # Create production environment file
          echo "ğŸ“ Creating production environment file..."
          cat > ../backend/.env << ENVEOF
          NODE_ENV=production
          PORT=3001
          DB_HOST=localhost
          DB_PORT=5432
          DB_NAME=wick_wax_relax
          DB_USER=wick_wax_user
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }}
          ENVEOF

          # Install PM2 if not installed
          echo "ğŸ”§ Checking PM2 installation..."
          if ! command -v pm2 &> /dev/null; then
            echo "ğŸ“¦ Installing PM2..."
            # Use the full path to npm or install without sudo if possible
            if command -v npm &> /dev/null; then
              # Try installing PM2 as current user first
              npm install -g pm2
            else
              # Find npm path and use sudo with full path
              NPM_PATH=$(which npm 2>/dev/null || echo "/usr/bin/npm")
              if [ -f "$NPM_PATH" ]; then
                sudo "$NPM_PATH" install -g pm2
              else
                # Fallback: install nodejs and npm if not available
                echo "âš ï¸  npm not found, installing Node.js and npm..."
                sudo apt update
                sudo apt install -y nodejs npm
                sudo npm install -g pm2
              fi
            fi
          fi

          # Restart application
          echo "ğŸ”„ Restarting application..."
          pm2 stop wick-wax-relax-api 2>/dev/null || true
          pm2 delete wick-wax-relax-api 2>/dev/null || true
          pm2 start server.js --name wick-wax-relax-api --env-file .env

          # Wait for application to start
          echo "â³ Waiting for application to start..."
          sleep 15

          # Health check with retry
          echo "ğŸ¥ Running health check..."
          for i in {1..5}; do
            if curl -f http://localhost:3001/api/health >/dev/null 2>&1; then
              echo "âœ… Deployment successful!"
              echo "ğŸŒ Frontend: https://www.wickwaxrelax.co.uk"
              echo "ğŸ”— Backend API: https://www.wickwaxrelax.co.uk/api"
              echo ""
              echo "ğŸ” Admin Login Credentials:"
              echo "   Email: admin@wickwaxrelax.co.uk"
              echo "   Password: admin123"
              echo ""
              echo "âš ï¸  IMPORTANT: Change the default admin password immediately!"
              exit 0
            fi
            echo "Attempt $i failed, retrying in 5 seconds..."
            sleep 5
          done

          echo "âŒ Health check failed after 5 attempts"
          pm2 stop wick-wax-relax-api
          exit 1
        EOF

    - name: Notify deployment success
      if: success()
      run: |
        echo "âœ… Deployment completed successfully"
        echo "ğŸ” Admin credentials provided in deployment output"

    - name: Notify deployment failure
      if: failure()
      run: |
        echo "âŒ Deployment failed"